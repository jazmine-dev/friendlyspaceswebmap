<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family-Friendly Venues Map - Bern</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Mobile summary bar */
        #mobile-summary-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 16px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 1002;
        }

        #mobile-summary-bar .count {
            font-size: 14px;
            color: #333;
        }

        #mobile-filter-toggle {
            background: #1E52BA;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #sheet-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            z-index: 1000;
        }

        #sheet-backdrop.visible {
            display: block;
        }

        #sidebar {
            width: 350px;
            background: #ffffff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            transition: transform 0.3s ease;
        }

        #sidebar.collapsed {
            transform: translateX(-350px);
        }

        #sidebar-header {
            padding: 20px;
            background: #1E52BA;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #sidebar-header h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .language-toggle {
            display: none;
        }

        #search-container {
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #1E52BA;
        }

        #search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #search-dropdown.show {
            display: block;
        }

        .search-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .search-dropdown-item:last-child {
            border-bottom: none;
        }

        .search-dropdown-item:hover {
            background: #f8f9fa;
        }

        .search-dropdown-item strong {
            color: #1E52BA;
        }

        #filters-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .filter-category {
            margin-bottom: 25px;
            border-radius: 12px;
            border: 1px solid #eee;
            padding: 12px;
            background: #fafbff;
        }

        .filter-category h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .filter-category h3::after {
            content: '▾';
            font-size: 12px;
            color: #1E52BA;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-category.collapsed .filter-buttons {
            display: none;
        }

        .filter-category.collapsed h3::after {
            content: '▸';
        }

        .filter-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
            user-select: none;
        }

        .filter-button:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .filter-button.active {
            background: #1E52BA;
            border-color: #1E52BA;
            color: white;
        }

        .filter-button .count {
            font-size: 11px;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .filter-button.active .count {
            background: #F8F5EF;
            color: #1E52BA;
        }

        #active-filters {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #filter-count {
            font-size: 14px;
            color: #1E52BA;
            font-weight: 600;
        }

        #clear-filters {
            background: none;
            border: 1px solid #1E52BA;
            color: #1E52BA;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        #clear-filters:hover {
            background: #1E52BA;
            color: white;
        }

        #clear-filters:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #toggle-sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: none;
        }

        #result-count {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #666;
        }

        .leaflet-popup-content h3 {
            margin-top: 0;
            color: #1E52BA;
        }

        .venue-tags {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .venue-tag {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }

            #container {
                flex-direction: column;
                min-height: 100dvh;
            }

            #mobile-summary-bar {
                display: flex;
            }

            #sidebar {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-height: 70dvh;
                transform: translateY(100%);
                box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
                border-radius: 16px 16px 0 0;
                transition: transform 0.3s ease;
                padding-top: 12px;
                padding-bottom: 20px;
            }

            #sidebar.show {
                transform: translateY(0);
            }

            #filters-container {
                max-height: 50dvh;
                padding-top: 10px;
            }

            #active-filters {
                position: sticky;
                bottom: 0;
                background: white;
            }

            #map {
                height: calc(100dvh - 60px);
                min-height: 50dvh;
            }

            #toggle-sidebar {
                display: none !important;
            }
        }

        /* Custom scrollbar */
        #filters-container::-webkit-scrollbar {
            width: 6px;
        }

        #filters-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #filters-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #filters-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Marker cluster styling */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background: #1E52BA;
        }

        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            background: #1E52BA;
            color: white;
            font-weight: bold;
        }

        .marker-cluster {
            background-clip: padding-box;
        }

        /* Image slider styles */
        .venue-slider {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 8px;
        }

        .venue-slider img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            flex-shrink: 0;
            flex: 0 0 100%;
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        .slider-container {
            display: flex;
            width: auto;
            min-width: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-arrow:hover {
            background: white;
        }

        .slider-arrow.prev {
            left: 5px;
        }

        .slider-arrow.next {
            right: 5px;
        }

        .slider-dots {
            text-align: center;
            padding: 5px 0;
            position: absolute;
            bottom: 5px;
            width: 100%;
        }

        .slider-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 3px;
        }

        .slider-dot.active {
            background: white;
        }

        /* Popup sizing */
        .custom-popup .leaflet-popup-content-wrapper {
            max-width: 400px;
            width: clamp(280px, 90vw, 400px);
        }

        .custom-popup .leaflet-popup-content {
            margin: 8px 10px;
            max-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div id="sheet-backdrop"></div>
    <div id="mobile-summary-bar">
        <span class="count">Showing <strong id="venue-count-mobile">0</strong> venues</span>
        <button id="mobile-filter-toggle">Filters</button>
    </div>
    <div id="container">
        <aside id="sidebar">
            <div id="sidebar-header">
                <h2 id="sidebar-title">Find Venues</h2>
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Search by name, city, or address...">
                    <span id="search-icon" aria-hidden="true">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1E52BA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="7"></circle>
                            <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                        </svg>
                    </span>
                    <div id="search-dropdown"></div>
                </div>
            </div>

            <div id="result-count">Showing <strong id="venue-count">0</strong> venues</div>

            <div id="filters-container">
                <div class="filter-category">
                    <h3 data-category-heading="venueType">Venue Type</h3>
                    <div class="filter-buttons" id="venueType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="cuisineType">Cuisine Type</h3>
                    <div class="filter-buttons" id="cuisineType-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="ageRange">Age Range</h3>
                    <div class="filter-buttons" id="ageRange-filters"></div>
                </div>

                <div class="filter-category">
                    <h3 data-category-heading="amenities">Amenities</h3>
                    <div class="filter-buttons" id="amenities-filters"></div>
                </div>
            </div>

            <div id="active-filters">
                <span id="filter-count">0 filters active</span>
                <button id="clear-filters" disabled>Clear All</button>
            </div>
        </aside>

        <div style="position: relative; flex: 1;">
            <button id="toggle-sidebar">☰</button>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Language support (German/French) with query param override (?lang=de|fr)
        const supportedLanguages = ['de', 'fr', 'en'];
        const translations = {
            de: {
                ui: {
                    title: "Familienfreundliche Karte - Bern",
                    sidebarTitle: "Orte finden",
                    searchPlaceholder: "Nach Name, Stadt oder Adresse suchen...",
                    languageLabel: "Sprache",
                    showingLabel: "Zeige",
                    venuesLabel: "Orte",
                    filtersLabel: "Filter",
                    clearFilters: "Alle löschen",
                    filtersActive: (count) => count === 1 ? "1 Filter aktiv" : `${count} Filter aktiv`,
                    filtersButton: (count) => count > 0 ? `Filter (${count})` : "Filter",
                    cityCount: (count) => count === 1 ? "1 Ort" : `${count} Orte`,
                },
                filters: {
                    categories: {
                        venueType: "Ortstyp",
                        cuisineType: "Küche",
                        ageRange: "Altersgruppe",
                        amenities: "Ausstattung"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Kreativ-Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Kleinkind (2-3)",
                            "small-child": "Kind (4-6)",
                            kid: "Schulkind (7-12)"
                        },
                        amenities: {
                            playground: "Spielplatz",
                            "outdoor-seating": "Aussensitzplätze",
                            "play-area": "Spielbereich",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Kinderstuhl",
                            "change-table": "Wickeltisch",
                            "games-room": "Spielzimmer"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Webseite besuchen",
                    hours: "Öffnungszeiten",
                    specialty: "Besonderheit",
                    directions: "Route planen"
                }
            },
            fr: {
                ui: {
                    title: "Carte des lieux familiaux - Berne",
                    sidebarTitle: "Trouver des lieux",
                    searchPlaceholder: "Rechercher par nom, ville ou adresse...",
                    languageLabel: "Langue",
                    showingLabel: "Afficher",
                    venuesLabel: "lieux",
                    filtersLabel: "Filtres",
                    clearFilters: "Tout effacer",
                    filtersActive: (count) => count === 1 ? "1 filtre actif" : `${count} filtres actifs`,
                    filtersButton: (count) => count > 0 ? `Filtres (${count})` : "Filtres",
                    cityCount: (count) => count === 1 ? "1 lieu" : `${count} lieux`,
                },
                filters: {
                    categories: {
                        venueType: "Type de lieu",
                        cuisineType: "Type de cuisine",
                        ageRange: "Tranche d'âge",
                        amenities: "Équipements"
                    },
                    options: {
                        venueType: {
                            cafe: "Café",
                            "craft-atelier": "Atelier créatif",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Végane",
                            bistro: "Bistrot",
                            patisserie: "Pâtisserie",
                            international: "Cuisine internationale"
                        },
                        ageRange: {
                            baby: "Bébé (0-1)",
                            toddler: "Tout-petit (2-3)",
                            "small-child": "Jeune enfant (4-6)",
                            kid: "Enfant (7-12)"
                        },
                        amenities: {
                            playground: "Terrain de jeu",
                            "outdoor-seating": "Terrasse extérieure",
                            "play-area": "Aire de jeux",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "Chaise haute",
                            "change-table": "Table à langer",
                            "games-room": "Salle de jeux"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visiter le site",
                    hours: "Horaires",
                    specialty: "Spécialité",
                    directions: "Itinéraire"
                }
            },
            en: {
                ui: {
                    title: "Family-Friendly Venues Map - Bern",
                    sidebarTitle: "Find Venues",
                    searchPlaceholder: "Search by name, city, or address...",
                    languageLabel: "Language",
                    showingLabel: "Showing",
                    venuesLabel: "venues",
                    filtersLabel: "Filters",
                    clearFilters: "Clear All",
                    filtersActive: (count) => count === 1 ? "1 filter active" : `${count} filters active`,
                    filtersButton: (count) => count > 0 ? `Filters (${count})` : "Filters",
                    cityCount: (count) => count === 1 ? "1 venue" : `${count} venues`,
                },
                filters: {
                    categories: {
                        venueType: "Venue Type",
                        cuisineType: "Cuisine Type",
                        ageRange: "Age Range",
                        amenities: "Amenities"
                    },
                    options: {
                        venueType: {
                            cafe: "Cafe",
                            "craft-atelier": "Creative Atelier",
                            "food-hall": "Food Hall"
                        },
                        cuisineType: {
                            vegan: "Vegan",
                            bistro: "Bistro",
                            patisserie: "Patisserie",
                            international: "International"
                        },
                        ageRange: {
                            baby: "Baby (0-1)",
                            toddler: "Toddler (2-3)",
                            "small-child": "Small Child (4-6)",
                            kid: "Kid (7-12)"
                        },
                        amenities: {
                            playground: "Playground",
                            "outdoor-seating": "Outdoor Seating",
                            "play-area": "Play Area",
                            "friendly-spaces": "Friendly Spaces Playbox",
                            "high-chair": "High Chair",
                            "change-table": "Change Table",
                            "games-room": "Games Room"
                        }
                    }
                },
                popup: {
                    visitWebsite: "Visit Website",
                    hours: "Hours",
                    specialty: "Specialty",
                    directions: "Directions"
                }
            }
        };

        let currentLang = getPreferredLanguage();

        function getPreferredLanguage() {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = params.get('lang')?.toLowerCase();
            if (fromQuery && supportedLanguages.includes(fromQuery)) return fromQuery;

            const browser = (navigator.language || navigator.userLanguage || '').slice(0, 2).toLowerCase();
            if (supportedLanguages.includes(browser)) return browser;

            return 'de'; // default to German
        }

        document.documentElement.lang = currentLang;

        function translate(path, fallback) {
            const segments = path.split('.');
            const value =
                segments.reduce((obj, key) => obj?.[key], translations[currentLang]) ??
                segments.reduce((obj, key) => obj?.[key], translations['de']);
            return value !== undefined ? value : fallback;
        }

        function formatPhoneHref(phone) {
            if (!phone) return null;
            if (/contact via website/i.test(phone)) return null;
            const normalized = phone.replace(/[^+\d]/g, '');
            if (!normalized || normalized.replace(/\D/g, '').length === 0) return null;
            return `tel:${normalized}`;
        }

        // Helper to get localized venue text fields
        function getVenueText(venue, field) {
            const localized = venue.i18n?.[field];
            if (localized && typeof localized === 'object') {
                return localized[currentLang] ||
                    venue[field] ||
                    localized['en'] ||
                    localized['de'] ||
                    '';
            }
            return venue[field] || '';
        }

        // Venue data with filter tags
        const venues = [
            {
                name: "Orangerie Elfenau",
                address: "Elfenauweg 92, 3006 Bern",
                city: "Bern",
                description: "Elegant cafe and bistro in a historic orangery surrounded by beautiful gardens",
                i18n: {
                    description: {
                        de: "Elegantes Café und Bistro in einer historischen Orangerie mit Gartenambiente",
                        fr: "Café-bistro élégant dans une orangerie historique entourée de jardins"
                    },
                    hours: {
                        de: "Mi-So: 11-19 Uhr (Saisonzeiten können variieren)",
                        fr: "Mer-dim : 11h-19h (horaires saisonniers variables)"
                    },
                    specialty: {
                        de: "Gartenterrasse und hausgemachte Kuchen",
                        fr: "Terrasse jardin et gâteaux maison"
                    }
                },
                hours: "Wed-Sun: 11am-7pm (seasonal hours may vary)",
                specialty: "Garden terrace and homemade cakes",
                seasonalNote: {
                    de: "Derzeit geschlossen bis April (Saisonbetrieb)",
                    fr: "Actuellement fermé jusqu'en avril (ouverture saisonnière)",
                    en: "Currently closed until April (seasonal)"
                },
                phone: "+41 31 350 16 20",
                website: "https://orangerieelfenau.ch/",
                images: [
                    "assets/bern/Orangerie_Elfenau/Orangerie_01.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_02.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_03.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_04.jpg",
                    "assets/bern/Orangerie_Elfenau/Orangerie_06.jpg"
                ],
                fallbackCoords: [46.9330368, 7.4659898],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["bistro"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["outdoor-seating", "playground", "friendly-spaces", "high-chair", "change-table"]
                }
            },
            {
                name: "Love is Sweet Atelier",
                address: "Socinstrasse 2, 4051 Basel",
                city: "Basel",
                description: "Creative craft atelier offering art workshops for children including jewelry, ceramics, painting, and more",
                i18n: {
                    description: {
                        de: "Kreatives Atelier mit Kunstworkshops für Kinder, darunter Schmuck, Keramik, Malen und mehr",
                        fr: "Atelier créatif proposant des ateliers d'art pour enfants : bijoux, céramique, peinture et plus"
                    },
                    hours: {
                        de: "Workshop-Zeiten variieren – siehe Website für den Plan",
                        fr: "Horaires des ateliers variables – consulter le site pour le planning"
                    },
                    specialty: {
                        de: "Kunstworkshops und kreative Aktivitäten für Kinder",
                        fr: "Ateliers d'art et activités créatives pour enfants"
                    }
                },
                hours: "Workshop hours vary - check website for schedule",
                specialty: "Art workshops and creative activities for kids",
                phone: "Contact via website",
                website: "https://loveissweet.ch/",
                images: [
                    "assets/basel/LIS_Atelier/LIS_Atelier_01.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_02.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_03.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_04.jpg",
                    "assets/basel/LIS_Atelier/LIS_Atelier_05.jpg"
                ],
                fallbackCoords: [47.5580748, 7.5792603],
                filters: {
                    venueType: ["craft-atelier"],
                    cuisineType: [],
                    ageRange: ["toddler", "small-child", "kid"],
                    amenities: ["high-chair", "change-table"]
                }
            },
            {
                name: "Magical Cafe",
                address: "Max Kämpf Platz 2, 4058 Basel",
                city: "Basel",
                description: "Family-friendly cafe with homemade cupcakes, coffee, and large indoor play area for children",
                i18n: {
                    description: {
                        de: "Familienfreundliches Café mit hausgemachten Cupcakes, Kaffee und grossem Indoor-Spielbereich",
                        fr: "Café familial avec cupcakes maison, café et grande aire de jeux intérieure"
                    },
                    hours: {
                        de: "Di-Fr: 10-17 Uhr (Wochenenden für Privatfeiern reserviert)",
                        fr: "Mar-ven : 10h-17h (week-ends réservés aux fêtes privées)"
                    },
                    specialty: {
                        de: "Hausgemachte Cupcakes und thematische Geburtstagsfeiern",
                        fr: "Cupcakes maison et fêtes d'anniversaire à thème"
                    }
                },
                hours: "Tue-Fri: 10am-5pm (weekends reserved for private parties)",
                specialty: "Homemade cupcakes and themed birthday parties",
                phone: "+41 78 905 37 38",
                website: "https://magicalcafe.ch/",
                images: [
                    "assets/basel/Magical_Cafe/magical_cafe_01.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_02.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_03.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_04.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_05.jpg",
                    "assets/basel/Magical_Cafe/magical_cafe_06.jpg"
                ],
                fallbackCoords: [47.5699729, 7.5995347],
                filters: {
                    venueType: ["cafe"],
                    cuisineType: ["patisserie"],
                    ageRange: ["baby", "toddler", "small-child"],
                    amenities: ["play-area", "outdoor-seating", "high-chair", "change-table"]
                }
            },
            {
                name: "Klara 13",
                address: "Clarastrasse 13, 4058 Basel",
                city: "Basel",
                description: "Community food hall and cafe at Claraplatz with diverse kitchens from 5 continents and family-friendly space",
                i18n: {
                    description: {
                        de: "Gemeinschaftliche Foodhall und Café am Claraplatz mit Küchen aus 5 Kontinenten und familienfreundlichem Bereich",
                        fr: "Halle gourmande communautaire et café à Claraplatz avec cuisines variées des 5 continents et espace familial"
                    },
                    hours: {
                        de: "Mo-So: 10-22 Uhr (Küchenzeiten können variieren)",
                        fr: "Lun-dim : 10h-22h (horaires des cuisines variables)"
                    },
                    specialty: {
                        de: "Verschiedene Küchen unter einem Dach, zentrale Lage",
                        fr: "Plusieurs cuisines sous un même toit, emplacement central"
                    }
                },
                hours: "Daily: 10am-10pm (kitchen hours may vary)",
                specialty: "Multiple kitchens under one roof, central Claraplatz location",
                phone: "Contact via website",
                website: "https://www.klarabasel.ch/",
                images: [
                    "assets/basel/Klara/klara_01.jpg",
                    "assets/basel/Klara/klara_02.jpg",
                    "assets/basel/Klara/klara_03.jpg",
                    "assets/basel/Klara/klara_04.jpg",
                    "assets/basel/Klara/klara_05.jpg",
                    "assets/basel/Klara/klara_06.jpg",
                    "assets/basel/Klara/klara_07.jpg"
                ],
                fallbackCoords: [47.5660, 7.5950],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "games-room"]
                }
            },
            {
                name: "Markthalle Basel",
                address: "Steinentorberg 20, 4051 Basel",
                city: "Basel",
                description: "Historic market hall with international food stalls, cafes, open seating, and a family-friendly play area",
                i18n: {
                    description: {
                        de: "Historische Markthalle mit internationalen Food-Ständen, Cafés, offenen Sitzplätzen und einem familienfreundlichen Spielbereich",
                        fr: "Halle historique avec stands de cuisine internationale, cafés, places assises ouvertes et une aire de jeux familiale"
                    },
                    hours: {
                        de: "Mo-Sa: 8-23 Uhr (Stände variieren)",
                        fr: "Lun-sam : 8h-23h (horaires des stands variables)"
                    },
                    specialty: {
                        de: "Vielfältige Küche unter einer Kuppel, zentrale Lage am Bahnhof SBB",
                        fr: "Cuisine variée sous un dôme, emplacement central près de la gare CFF"
                    }
                },
                hours: "Mon-Sat: 8am-11pm (stalls vary)",
                specialty: "Varied kitchens under one dome, central near Basel SBB",
                phone: "Contact via website",
                website: "https://www.altemarkthalle.ch/",
                images: [
                    "assets/basel/Markthalle/markthalle_01.jpg",
                    "assets/basel/Markthalle/markthalle_02.jpg",
                    "assets/basel/Markthalle/markthalle_03.jpg",
                    "assets/basel/Markthalle/markthalle_04.jpg",
                    "assets/basel/Markthalle/markthalle_05.jpg",
                    "assets/basel/Markthalle/markthalle_06.jpg"
                ],
                fallbackCoords: [47.5480, 7.5898],
                filters: {
                    venueType: ["food-hall"],
                    cuisineType: ["international"],
                    ageRange: ["baby", "toddler", "small-child", "kid"],
                    amenities: ["play-area", "high-chair", "change-table", "outdoor-seating"]
                }
            }
        ];

        // Filter definitions
        const filterDefinitions = {
            venueType: [
                { id: "cafe", label: "Cafe" },
                { id: "craft-atelier", label: "Creative Atelier" },
                { id: "food-hall", label: "Food Hall" }
            ],
            cuisineType: [
                { id: "vegan", label: "Vegan" },
                { id: "bistro", label: "Bistro" },
                { id: "patisserie", label: "Patisserie" },
                { id: "international", label: "International" }
            ],
            ageRange: [
                { id: "baby", label: "Baby (0-1)" },
                { id: "toddler", label: "Toddler (2-3)" },
                { id: "small-child", label: "Small Child (4-6)" },
                { id: "kid", label: "Kid (7-12)" }
            ],
            amenities: [
                { id: "playground", label: "Playground" },
                { id: "outdoor-seating", label: "Outdoor Seating" },
                { id: "play-area", label: "Play Area" },
                { id: "friendly-spaces", label: "Friendly Spaces Playbox" },
                { id: "high-chair", label: "High Chair" },
                { id: "change-table", label: "Change Table" },
                { id: "games-room", label: "Games Room" }
            ]
        };

        // Initialize map with zoom controls in bottom right
        const map = L.map('map', {
            zoomControl: false
        });

        // Disable scroll zoom until the map is focused/clicked to prevent trapping page scroll
        map.scrollWheelZoom.disable();
        map.on('focus', () => map.scrollWheelZoom.enable());
        map.on('blur', () => map.scrollWheelZoom.disable());
        map.on('click', () => map.scrollWheelZoom.enable());

        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Initialize marker cluster group
        let markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 150,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            disableClusteringAtZoom: 13,
            spiderfyDistanceMultiplier: 1.5
        });

        // Custom marker icon (brand blue gradient)
        const pinSvg = `
            <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="pinGrad" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" stop-color="#2F6BE0"/>
                        <stop offset="100%" stop-color="#1E52BA"/>
                    </linearGradient>
                    <filter id="pinShadow" x="-20%" y="-10%" width="140%" height="130%">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.25)"/>
                    </filter>
                </defs>
                <g filter="url(#pinShadow)">
                    <path fill="url(#pinGrad)" d="M16 0c-7.18 0-13 5.82-13 13 0 9.75 8.9 18.9 12.1 21.83.5.46 1.3.46 1.8 0C20.1 31.9 29 22.75 29 13 29 5.82 23.18 0 16 0Z"/>
                    <circle cx="16" cy="13" r="5" fill="rgba(255,255,255,0.9)"/>
                </g>
            </svg>
        `;

        const markerIcon = L.icon({
            iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(pinSvg),
            iconSize: [32, 48],
            iconAnchor: [16, 46],
            popupAnchor: [0, -42]
        });

        // Add click event to zoom into clusters
        markerClusterGroup.on('clusterclick', function (a) {
            // Prevent default cluster click behavior
            a.originalEvent.stopPropagation();

            // Get the bounds and zoom manually
            const bounds = a.layer.getBounds();

            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 14,
                animate: true
            });

            // Force refresh after animation
            setTimeout(function() {
                markerClusterGroup.refreshClusters();
                map.invalidateSize();
                setTimeout(function() {
                    map.panBy([1, 0]);
                    map.panBy([-1, 0]);
                }, 50);
            }, 400);
        });

        map.addLayer(markerClusterGroup);

        // State
        let markers = [];
        let activeFilters = {
            venueType: [],
            cuisineType: [],
            ageRange: [],
            amenities: []
        };
        let searchQuery = '';
        let isInitialLoad = true;
        const sidebar = document.getElementById('sidebar');
        const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
        const sheetBackdrop = document.getElementById('sheet-backdrop');

        // City coordinates for zoom
        const cityCoordinates = {
            'bern': [46.9480, 7.4474, 13],
            'basel': [47.5596, 7.5886, 13]
        };

        const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

        function renderCountWrappers() {
            const resultCount = document.getElementById('result-count');
            const mobileCount = document.querySelector('#mobile-summary-bar .count');
            const showingLabel = translate('ui.showingLabel', 'Showing');
            const venuesLabel = translate('ui.venuesLabel', 'venues');

            if (resultCount) {
                resultCount.innerHTML = `${showingLabel} <strong id="venue-count">0</strong> ${venuesLabel}`;
            }

            if (mobileCount) {
                mobileCount.innerHTML = `${showingLabel} <strong id="venue-count-mobile">0</strong> ${venuesLabel}`;
            }
        }

        function applyTranslations() {
            document.title = translate('ui.title', document.title);
            const sidebarTitle = document.getElementById('sidebar-title');
            if (sidebarTitle) sidebarTitle.textContent = translate('ui.sidebarTitle', sidebarTitle.textContent);

            const searchInputEl = document.getElementById('search-input');
            if (searchInputEl) searchInputEl.placeholder = translate('ui.searchPlaceholder', searchInputEl.placeholder);

            const mobileToggle = document.getElementById('mobile-filter-toggle');
            if (mobileToggle) mobileToggle.textContent = translate('ui.filtersLabel', mobileToggle.textContent);

            const clearBtn = document.getElementById('clear-filters');
            if (clearBtn) clearBtn.textContent = translate('ui.clearFilters', clearBtn.textContent);

            document.querySelectorAll('[data-category-heading]').forEach(heading => {
                const cat = heading.getAttribute('data-category-heading');
                heading.textContent = translate(`filters.categories.${cat}`, heading.textContent);
            });

            renderCountWrappers();
        }

        function updateLanguageToggleActive() {
            const buttons = document.querySelectorAll('#language-toggle button');
            buttons.forEach(btn => {
                const lang = btn.getAttribute('data-lang');
                btn.classList.toggle('active', lang === currentLang);
            });
        }

        function setLanguage(lang, { skipUrlUpdate = false } = {}) {
            if (!supportedLanguages.includes(lang)) return;
            currentLang = lang;
            document.documentElement.lang = lang;

            if (!skipUrlUpdate) {
                const url = new URL(window.location.href);
                url.searchParams.set('lang', lang);
                history.replaceState({}, '', url.toString());
            }

            applyTranslations();
            createFilterButtons();
            updateFilterCount();
            updateMap();
        }

        function openFilterSheet() {
            if (!isMobile()) return;
            sidebar.classList.add('show');
            sheetBackdrop.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeFilterSheet(force = false) {
            if (!isMobile() && !force) return;
            sidebar.classList.remove('show');
            sheetBackdrop.classList.remove('visible');
            document.body.style.overflow = isMobile() ? 'auto' : 'hidden';
        }

        function setupAccordions() {
            document.querySelectorAll('.filter-category h3').forEach(header => {
                header.addEventListener('click', () => {
                    if (!isMobile()) return;
                    header.parentElement.classList.toggle('collapsed');
                });
            });
        }

        function collapseFiltersForMobile() {
            const categories = document.querySelectorAll('.filter-category');

            if (!isMobile()) {
                categories.forEach(cat => cat.classList.remove('collapsed'));
                return;
            }

            categories.forEach((cat, index) => {
                cat.classList.toggle('collapsed', index !== 0);
            });
        }

        function handleResize() {
            collapseFiltersForMobile();
            if (!isMobile()) {
                closeFilterSheet(true);
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }

        // Helper: Count venues with specific filter
        function countVenuesWithFilter(category, filterId) {
            return venues.filter(v => v.filters[category].includes(filterId)).length;
        }

        // Create filter buttons
        function createFilterButtons() {
            Object.keys(filterDefinitions).forEach(category => {
                const container = document.getElementById(`${category}-filters`);
                if (!container) return;
                container.innerHTML = '';

                const heading = document.querySelector(`[data-category-heading="${category}"]`);
                if (heading) {
                    heading.textContent = translate(`filters.categories.${category}`, heading.textContent);
                }

                filterDefinitions[category].forEach(filter => {
                    const count = countVenuesWithFilter(category, filter.id);

                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    if (activeFilters[category].includes(filter.id)) {
                        button.classList.add('active');
                    }
                    button.dataset.category = category;
                    button.dataset.value = filter.id;

                    const labelSpan = document.createElement('span');
                    const labelText = translate(`filters.options.${category}.${filter.id}`, filter.label || filter.id);
                    labelSpan.textContent = typeof labelText === 'function' ? labelText() : labelText;

                    const countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    countSpan.textContent = count;

                    button.appendChild(labelSpan);
                    button.appendChild(countSpan);

                    button.addEventListener('click', () => handleFilterClick(button, category, filter.id));

                    container.appendChild(button);
                });
            });
        }

        // Handle filter button clicks
        function handleFilterClick(button, category, value) {
            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                activeFilters[category].push(value);
            } else {
                activeFilters[category] = activeFilters[category].filter(v => v !== value);
            }

            updateMap();
            updateFilterCount();
        }

        // Search functionality with dropdown
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-dropdown');

        function updateSearchDropdown(query) {
            if (!query || query.length < 2) {
                searchDropdown.classList.remove('show');
                return;
            }

            const suggestions = [];

            // Add matching cities
            Object.keys(cityCoordinates).forEach(city => {
                if (city.toLowerCase().includes(query)) {
                    const venueCount = venues.filter(v => v.city.toLowerCase() === city.toLowerCase()).length;
                    const countLabel = translate('ui.cityCount', `${venueCount} venues`);
                    suggestions.push({
                        type: 'city',
                        name: city.charAt(0).toUpperCase() + city.slice(1),
                        count: typeof countLabel === 'function' ? countLabel(venueCount) : countLabel
                    });
                }
            });

            // Add matching venues
            venues.forEach(venue => {
                if (venue.name.toLowerCase().includes(query) ||
                    venue.address.toLowerCase().includes(query)) {
                    suggestions.push({
                        type: 'venue',
                        name: venue.name,
                        city: venue.city,
                        venue: venue
                    });
                }
            });

            if (suggestions.length === 0) {
                searchDropdown.classList.remove('show');
                return;
            }

            // Limit to 5 suggestions
            const limitedSuggestions = suggestions.slice(0, 5);

            searchDropdown.innerHTML = limitedSuggestions.map(s => {
                if (s.type === 'city') {
                    return `<div class="search-dropdown-item" data-type="city" data-city="${s.name.toLowerCase()}">
                        <strong>📍 ${s.name}</strong> - ${s.count}
                    </div>`;
                } else {
                    return `<div class="search-dropdown-item" data-type="venue" data-venue="${s.name}">
                        ${s.name} <span style="color: #999;">- ${s.city}</span>
                    </div>`;
                }
            }).join('');

            searchDropdown.classList.add('show');

            // Add click handlers
            searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    if (type === 'city') {
                        const city = item.dataset.city;
                        handleCitySearch(city);
                    } else {
                        const venueName = item.dataset.venue;
                        handleVenueSearch(venueName);
                    }
                });
            });
        }

        function handleCitySearch(city) {
            searchInput.value = city.charAt(0).toUpperCase() + city.slice(1);
            searchQuery = city.toLowerCase();
            searchDropdown.classList.remove('show');

            // Zoom to city
            const coords = cityCoordinates[city.toLowerCase()];
            if (coords) {
                map.setView([coords[0], coords[1]], coords[2]);
            }

            updateMap();
        }

        function handleVenueSearch(venueName) {
            const venue = venues.find(v => v.name === venueName);
            if (venue) {
                searchInput.value = venue.name;
                searchQuery = venue.name.toLowerCase();
                searchDropdown.classList.remove('show');

                // Zoom to venue
                map.setView(venue.fallbackCoords, 15);

                updateMap();

                // Open venue popup after a short delay
                setTimeout(() => {
                    const marker = markers.find(m => m.venue.name === venueName);
                    if (marker) {
                        marker.marker.openPopup();
                    }
                }, 300);
            }
        }

        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            updateSearchDropdown(searchQuery);
            updateMap();
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchQuery) {
                // Check if it's a city name
                const cityMatch = Object.keys(cityCoordinates).find(city =>
                    city === searchQuery ||
                    searchQuery.includes(city)
                );

                if (cityMatch) {
                    handleCitySearch(cityMatch);
                } else {
                    searchDropdown.classList.remove('show');
                }
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                searchDropdown.classList.remove('show');
            }
        });

        // Clear filters
        document.getElementById('clear-filters').addEventListener('click', () => {
            // Remove active class from all filter buttons
            document.querySelectorAll('.filter-button.active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Reset active filters
            Object.keys(activeFilters).forEach(key => {
                activeFilters[key] = [];
            });

            // Clear search
            document.getElementById('search-input').value = '';
            searchQuery = '';

            // Reset map view to show all venues
            isInitialLoad = true;
            updateMap();
            updateFilterCount();
        });

        // Update filter count display
        function updateFilterCount() {
            const total = Object.values(activeFilters).flat().length;
            const countEl = document.getElementById('filter-count');
            const clearBtn = document.getElementById('clear-filters');

            const filterActiveText = translate('ui.filtersActive');
            countEl.textContent = typeof filterActiveText === 'function'
                ? filterActiveText(total)
                : `${total} filter${total !== 1 ? 's' : ''} active`;
            clearBtn.disabled = total === 0 && !searchQuery;

            const mobileToggleEl = document.getElementById('mobile-filter-toggle');
            if (mobileToggleEl) {
                const filtersButtonText = translate('ui.filtersButton');
                if (typeof filtersButtonText === 'function') {
                    mobileToggleEl.textContent = filtersButtonText(total);
                } else {
                    mobileToggleEl.textContent = filtersButtonText || (total > 0 ? `Filters (${total})` : 'Filters');
                }
            }
        }

        // Check if venue matches filters
        function venueMatchesFilters(venue) {
            // Search filter
            if (searchQuery) {
                const searchMatch =
                    venue.name.toLowerCase().includes(searchQuery) ||
                    venue.address.toLowerCase().includes(searchQuery) ||
                    venue.city.toLowerCase().includes(searchQuery);

                if (!searchMatch) return false;
            }

            // Category filters (AND logic - venue must have ALL selected filters)
            for (const [category, selectedFilters] of Object.entries(activeFilters)) {
                if (selectedFilters.length > 0) {
                    // Check if venue has ALL selected filters in this category
                    const hasAllFilters = selectedFilters.every(filter =>
                        venue.filters[category].includes(filter)
                    );
                    if (!hasAllFilters) return false;
                }
            }

            return true;
        }

        // Color scheme for filter categories
        const categoryColors = {
            venueType: '#3b82f6',      // Blue
            cuisineType: '#10b981',    // Green
            ageRange: '#f59e0b',       // Orange
            amenities: '#8b5cf6'       // Purple
        };

        // Create popup content with color-coded tags and image slider
        function createPopup(venue) {
            const visitWebsiteLabel = translate('popup.visitWebsite', 'Visit Website');
            const hoursLabel = translate('popup.hours', 'Hours');
            const specialtyLabel = translate('popup.specialty', 'Specialty');
            const seasonalNote = venue.seasonalNote
                ? (venue.seasonalNote[currentLang] || venue.seasonalNote.en || venue.seasonalNote.de)
                : null;

            const localizedDescription = getVenueText(venue, 'description');
            const localizedHours = getVenueText(venue, 'hours');
            const localizedSpecialty = getVenueText(venue, 'specialty');

            const tagsByCategory = Object.entries(venue.filters)
                .map(([category, values]) => {
                    const color = categoryColors[category];
                    const tags = values.map(v => {
                        const def = filterDefinitions[category].find(f => f.id === v);
                        const translated = translate(`filters.options.${category}.${v}`, def?.label || v);
                        const label = typeof translated === 'function' ? translated() : translated;
                        return `<span class="venue-tag" style="background: ${color}; color: white;">${label}</span>`;
                    }).join('');
                    return tags;
                })
                .join('');

            // Create Google Maps directions link
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(venue.address)}`;
            const phoneHref = formatPhoneHref(venue.phone);

            // Website link (if available)
            const websiteHtml = venue.website
                ? `<p style="margin: 5px 0; font-size: 13px;"><strong>🌐</strong> <a href="${venue.website}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${visitWebsiteLabel}</a></p>`
                : '';

            // Image slider (if images available)
            let sliderHtml = '';
            if (venue.images && venue.images.length > 0) {
                const sliderId = `slider-${venue.name.replace(/\s+/g, '-').toLowerCase()}`;
                const imagesHtml = venue.images.map(img => `<img src="${img}" alt="${venue.name}">`).join('');
                const dotsHtml = venue.images.map((_, i) =>
                    `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-slide="${i}"></span>`
                ).join('');

                sliderHtml = `
                    <div class="venue-slider" id="${sliderId}">
                        <div class="slider-container">${imagesHtml}</div>
                        ${venue.images.length > 1 ? `
                            <button class="slider-arrow prev" onclick="slideImage('${sliderId}', -1)">‹</button>
                            <button class="slider-arrow next" onclick="slideImage('${sliderId}', 1)">›</button>
                            <div class="slider-dots">${dotsHtml}</div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div style="min-width: 280px; max-width: 320px;">
                    ${sliderHtml}
                    <h3 style="margin: 0 0 10px 0;">${venue.name}</h3>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📍</strong> <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="color: #1E52BA; text-decoration: none;">${venue.address}</a></p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>📞</strong> ${phoneHref ? `<a href="${phoneHref}" style="color: #1E52BA; text-decoration: none;">${venue.phone}</a>` : venue.phone}</p>
                    ${websiteHtml}
                    <p style="margin: 8px 0; font-size: 13px;">${localizedDescription}</p>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>${hoursLabel}:</strong> ${localizedHours}</p>
                    ${seasonalNote ? `<p style="margin: 5px 0; font-size: 12px; color: #BA1E1E;"><strong>${seasonalNote}</strong></p>` : ''}
                    <p style="margin: 5px 0; font-size: 12px; color: #1E52BA;"><strong>${specialtyLabel}:</strong> ${localizedSpecialty}</p>
                    <div class="venue-tags">${tagsByCategory}</div>
                </div>
            `;
        }

        // Update map markers
        function updateMap() {
            // Clear existing markers from cluster group
            markerClusterGroup.clearLayers();
            markers = [];

            const bounds = L.latLngBounds([]);
            let visibleCount = 0;

            // Add markers for matching venues
            venues.forEach(venue => {
                if (venueMatchesFilters(venue)) {
                    const coords = venue.fallbackCoords;
                    const marker = L.marker(coords, { icon: markerIcon });
                    marker.bindPopup(createPopup(venue), {
                        className: 'custom-popup',
                        maxWidth: 380,
                        minWidth: 260,
                        autoPanPaddingTopLeft: [40, 40],
                        autoPanPaddingBottomRight: [40, 40]
                    });
                    marker.on('popupopen', (e) => {
                        const target = e.popup.getLatLng();
                        map.panTo(target, { animate: true });
                        // Nudge popup fully into view; try a stronger upward pan
                        setTimeout(() => map.panBy([0, -140], { animate: true }), 150);

                        const sliderEl = e.popup.getElement()?.querySelector('.slider-container');
                        attachSliderScrollSync(sliderEl);
                    });

                    // Add marker to cluster group instead of directly to map
                    markerClusterGroup.addLayer(marker);

                    markers.push({ venue, marker, coords });
                    bounds.extend(coords);
                    visibleCount++;
                }
            });

            // Update count
            document.getElementById('venue-count').textContent = visibleCount;
            const mobileCountEl = document.getElementById('venue-count-mobile');
            if (mobileCountEl) {
                mobileCountEl.textContent = visibleCount;
            }

            // Only auto-zoom on initial load
            if (isInitialLoad) {
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.2));
                } else {
                    map.setView([46.9480, 7.4474], 13);
                }
                isInitialLoad = false;
            }
        }

        if (mobileFilterToggle) {
            mobileFilterToggle.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    closeFilterSheet();
                } else {
                    openFilterSheet();
                }
            });
        }

        if (sheetBackdrop) {
            sheetBackdrop.addEventListener('click', () => closeFilterSheet());
        }

        window.addEventListener('resize', handleResize);

        // Image slider functionality
        const sliderIndices = {};

        function slideImage(sliderId, direction) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;

            const sliderContainer = slider.querySelector('.slider-container');
            const images = sliderContainer.querySelectorAll('img');
            const dots = slider.querySelectorAll('.slider-dot');

            if (!sliderIndices[sliderId]) {
                sliderIndices[sliderId] = 0;
            }

            // Calculate new index
            sliderIndices[sliderId] = (sliderIndices[sliderId] + direction + images.length) % images.length;

            // Update slider position via scroll
            const slideWidth = sliderContainer.clientWidth || slider.clientWidth;
            const targetScroll = sliderIndices[sliderId] * slideWidth;
            sliderContainer.scrollTo({ left: targetScroll, behavior: 'smooth' });

            // Update dots
            dots.forEach((dot, index) => {
                if (index === sliderIndices[sliderId]) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Make slideImage globally accessible for onclick handlers
        window.slideImage = slideImage;

        function attachSliderScrollSync(sliderEl) {
            if (!sliderEl || sliderEl.dataset.bound === 'true') return;
            const sliderId = sliderEl.closest('.venue-slider')?.id;
            if (!sliderId) return;
            sliderEl.dataset.bound = 'true';
            const dots = sliderEl.parentElement.querySelectorAll('.slider-dot');
            sliderEl.addEventListener('scroll', () => {
                const slideWidth = sliderEl.clientWidth || 1;
                const idx = Math.round(sliderEl.scrollLeft / slideWidth);
                sliderIndices[sliderId] = idx;
                dots.forEach((dot, i) => dot.classList.toggle('active', i === idx));
            });
        }

        // Initialize
        setLanguage(currentLang, { skipUrlUpdate: true });
        setupAccordions();
        handleResize();
    </script>
</body>
</html>
